# Chapter 7. 병렬 데이터 처리와 성능

# 병렬 스트림

## 병렬 스트림이란?	

- **각각의 스레드에서  처리**할 수 있도록 **스트림 요소를 여러 청크로 분할**한 스트림
- `parallelStream`으로 생성

## 올바른 사용법

- 병렬 스트림이 올바로 동작하려면 여러 스레드에 **공유된 가변 상태를 피하자**

## 효과적으로 사용법

- 순차 스트림과 병렬 스트림 중 어느게 좋을지 확신이 서지 않으면 **직접 벤치마크로 성능을 측정**하라.
- **박싱을 주의하라.**
  - 박싱 동작을 피할 수 있도록 기본형 특화 스트림을 제공하니 되도록이면 사용하자.
- **순차 스트림 보다 병렬 스트림에서 성능이 떨어지는 연산**이 있다.
  - 순서에 의존하는 연산(ex. `limit`, `findFirst`)는 큰 비용 발생. 반면 `findAny` 순서에 상관 없으므로 성능 좋음.
  - 정렬된 스트림에 `unordered`를 호출하면 비정렬 스트림을 얻을 수 있다.
    - 순서가 상관없다면 비정렬 스트림에 `limit`을 호출하자.
- 스트림에서 수행하는 **전체 파이프라인 연산 비용**을 고려하라.
  - 전체 스트림 파이프라인 처리비용 = N * Q
    - N : 처리해야할 요소 수
    - Q : 하나의 요소를 처리하는데 드는 비용

  - Q가 높아진다는 것은 병렬 스트림으로 성능 개선할 수 있는 가능성이 있음

- **소량의 데이터**에서는 병렬 스트림이 도움되지 않음
  - 병렬화 과정에서 생기는 부가비용이 더 클수도

- 스트림을 구성하는 **자료구조가 적절한지** 확인하라
  - `ArrayList`는 `LinkedList`보다 효율적으로 분할 가능

<img src="https://raw.githubusercontent.com/hscom96/ImageStore/main/images/2023/01/01/image-20230101142644143.png" alt="image-20230101142644143" style="width:50%;" />

- 스트림 특성과 파이프라인의 **중간 연산**이 스트림의 특성을 어떻게 바꾸는에 따라 분해 과정 성능이 달라질 수 있다.
  - 필터 연산이 있으면 스트림의 길이를 예측할 수 없으므로 효과적으로 스트림을 병렬처리할 수 있을지 알 수 없게됨
- **최종 연산의 병합과정 비용**을 살펴보라 
  - 병합 과정 비용이 비싸면 병렬 스트림으로 얻은 성능의 이익이 없어짐

